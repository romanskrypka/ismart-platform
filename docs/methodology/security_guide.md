# Гайд по безопасности Django-проектов с ИИ (Cursor)

## Оглавление

1.  [Философия: Security as Code с ИИ](#1-философия-security-as-code-с-ии)
2.  [Управление секретами: Никогда не храните ключи в коде](#2-управление-секретами-никогда-не-храните-ключи-в-коде)
3.  [Чек-лист безопасности Django](#3-чек-лист-безопасности-django)
4.  [OWASP Top 10 в контексте Django](#4-owasp-top-10-в-контексте-django)
5.  [Приложение: Промпты для Security Review в Cursor](#5-приложение-промпты-для-security-review-в-cursor)

---

## 1. Философия: Security as Code с ИИ

**Security as Code** — это подход, при котором задачи по обеспечению безопасности автоматизируются и встраиваются в CI/CD пайплайн. С ИИ-ассистентом этот подход выходит на новый уровень: мы можем использовать ИИ для проактивного поиска уязвимостей, анализа кода и генерации безопасных конфигураций.

**Ключевой принцип:** Безопасность — это не разовое мероприятие, а непрерывный процесс. ИИ-ассистент (Cursor) выступает в роли вашего личного младшего специалиста по безопасности, который помогает вам на каждом этапе.

| Задача безопасности | Классический подход | Подход с ИИ (Cursor) |
|---|---|---|
| Поиск уязвимостей | Ручной code review, статические анализаторы (SAST) | **Автоматический code review с помощью промпта** |
| Управление зависимостями | Ручная проверка `requirements.txt` | **Промпт для анализа зависимостей на уязвимости** |
| Настройка заголовков | Ручная настройка в `settings.py` | **Промпт для генерации безопасной конфигурации middleware** |
| Защита от инъекций | Использование ORM, параметризованные запросы | **Промпт для проверки кода на наличие raw SQL запросов** |

---

## 2. Управление секретами: Никогда не храните ключи в коде

Хранение секретов (ключи API, пароли от БД) в коде — одна из самых распространённых и опасных уязвимостей. Правильный подход — использовать переменные окружения.

**Инструмент:** `python-decouple`

**Процесс:**

1.  **Установка:**
    ```bash
    pip install python-decouple
    ```

2.  **Создание файла `.env`** в корне проекта (этот файл **НИКОГДА** не должен попадать в Git):
    ```
    # .env
    SECRET_KEY=your-super-secret-key
    DATABASE_URL=postgres://user:password@host:port/dbname
    OPENAI_API_KEY=sk-...
    ```

3.  **Добавление `.env` в `.gitignore`**:
    ```
    # .gitignore
    .env
    ```

4.  **Использование в `settings.py`**:
    ```python
    # settings.py
    from decouple import config
    
    SECRET_KEY = config("SECRET_KEY")
    DATABASE_URL = config("DATABASE_URL")
    OPENAI_API_KEY = config("OPENAI_API_KEY")
    ```

---

## 3. Чек-лист безопасности Django

Этот чек-лист нужно проходить перед каждым деплоем в продакшен.

### Конфигурация (`settings.py`)
-   [ ] `DEBUG = False` в продакшене.
-   [ ] `SECRET_KEY` загружается из переменных окружения.
-   [ ] `ALLOWED_HOSTS` заполнен и не содержит `*`.
-   [ ] `CSRF_COOKIE_SECURE = True` (для HTTPS).
-   [ ] `SESSION_COOKIE_SECURE = True` (для HTTPS).
-   [ ] Настроены безопасные заголовки (см. `django-secure`).

### Аутентификация и авторизация
-   [ ] Используется встроенная система аутентификации Django.
-   [ ] Пароли не хранятся в открытом виде (используются хэши).
-   [ ] Для всех views, требующих авторизации, используется `LoginRequiredMixin` или декоратор `@login_required`.
-   [ ] Права доступа проверяются на уровне view или с помощью `PermissionRequiredMixin`.

### Защита данных
-   [ ] Не используются "сырые" SQL-запросы. Всегда используется Django ORM.
-   [ ] В формах и шаблонах используется экранирование (в Django включено по умолчанию).
-   [ ] Загружаемые пользователями файлы валидируются (тип, размер).

### Зависимости
-   [ ] Все зависимости проверены на наличие известных уязвимостей (например, с помощью `pip-audit`).

---

## 4. OWASP Top 10 в контексте Django

| Уязвимость (OWASP) | Как Django защищает / Что нужно делать | Промпт для Cursor |
|---|---|---|
| **A01: Broken Access Control** | Встроенная система прав, `LoginRequiredMixin`, `PermissionRequiredMixin` | "Проверь все views в `core/views.py`. Убедись, что для каждого view, изменяющего данные, есть проверка прав доступа." |
| **A02: Cryptographic Failures** | Хэширование паролей по умолчанию, `SECRET_KEY` для подписи сессий | "Проверь `settings.py`. Убедись, что `SECRET_KEY` не хранится в коде, а загружается из переменных окружения." |
| **A03: Injection** | Django ORM по умолчанию защищает от SQL-инъекций. Шаблонизатор защищает от XSS. | "Найди в проекте все использования `RawSQL` или `connection.cursor().execute()`. Это потенциальные места для SQL-инъекций." |
| **A04: Insecure Design** | - | "Проанализируй бизнес-логику сброса пароля. Есть ли там возможность перебора токенов?" |
| **A05: Security Misconfiguration** | - | "Проверь `settings.py` на предмет небезопасных конфигураций. `DEBUG` должен быть `False`, `ALLOWED_HOSTS` заполнен." |
| **A06: Vulnerable Components** | - | "Установи `pip-audit` и запусти `pip-audit`. Проанализируй отчёт и предложи план обновления уязвимых пакетов." |
| **A07: Identification Failures** | Встроенная система аутентификации | "Проверь, что на всех формах входа и регистрации есть CSRF-токен." |
| **A08: Software Integrity Failures** | - | "Проверь `requirements.txt`. Убедись, что все зависимости закреплены с помощью `==`." |
| **A09: Security Logging Failures** | Встроенная система логирования | "Проверь код. Убедись, что все неудачные попытки входа и ошибки 500 логируются с уровнем `WARNING` или `ERROR`." |
| **A10: Server-Side Request Forgery** | - | "Найди в коде все места, где делается HTTP-запрос на URL, который может контролировать пользователь. Это потенциальная SSRF-уязвимость." |

---

## 5. Приложение: Промпты для Security Review в Cursor

### Промпт для полного аудита безопасности

```
Режим: Architect.
Загрузи: @docs/security_guide.md

Задача: Провести полный аудит безопасности проекта. Действуй по шагам из OWASP Top 10, адаптированным для Django.

Для каждой из 10 уязвимостей:
1.  Сформулируй, что ты будешь искать.
2.  Проанализируй код проекта.
3.  Сообщи о найденных потенциальных уязвимостях или подтверди, что защита на месте.
4.  Предложи конкретные изменения в коде для устранения уязвимостей, если они найдены.

Начни с A01: Broken Access Control.
```

### Промпт для проверки зависимостей

```
Режим: Code.

Задача: Проверить зависимости проекта на наличие известных уязвимостей.

1.  Выполни в терминале команду `pip install pip-audit`.
2.  Выполни команду `pip-audit`.
3.  Проанализируй вывод.
4.  Если найдены уязвимые пакеты, предложи обновлённые версии для `requirements.txt`.
```

### Промпт для проверки `settings.py`

```
Режим: Code.
Загрузи: @settings.py

Задача: Проверить файл настроек на соответствие чек-листу безопасности.

Проверь следующие пункты:
- `DEBUG`
- `SECRET_KEY`
- `ALLOWED_HOSTS`
- `CSRF_COOKIE_SECURE`
- `SESSION_COOKIE_SECURE`

Если найдены несоответствия, предложи исправления, используя `python-decouple` для секретов.
```
