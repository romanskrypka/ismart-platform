# Техническая Спецификация iSmart Platform

**Версия:** 1.0
**Дата:** 13.02.2026

## 1. Введение

Настоящий документ является технической спецификацией для проекта iSmart Platform. Его цель — формализовать и стандартизировать процессы разработки, документирования и дальнейшего развития платформы в соответствии с принятой стратегией, изложенной в `VISION.md` и `DEVELOPMENT_PLAN.md`.

Спецификация адаптирует современные методологии (GRACE, PCAM) к существующему технологическому стеку (PHP, Twig, JSON) и служит руководством для всех участников проекта.

## 2. Обзор Текущей Архитектуры

Платформа iSmart построена на принципах модульности и разделения данных и представления.

### 2.1. Жизненный цикл запроса

Ключевым элементом является класс `Application` (`/core/Bootstrap/Application.php`), который оркестрирует обработку входящего HTTP-запроса. Процесс выглядит следующим образом:

1.  **`index.php`**: Единая точка входа. Создает экземпляр `Application` и запускает его.
2.  **`Application::run()`**: Выполняется последовательность шагов:
    *   **`Redirector`**: Проверяет наличие редиректов в `redirects.json`.
    *   **`UrlParser`**: Разбирает URL на сегменты.
    *   **`LanguageDetector`**: Определяет язык на основе сегмента URL.
    *   **`Router`**: Определяет `page_id` (идентификатор страницы).
    *   **`PageDataLoader`**: Загружает JSON-данные для страницы из `/data/json/{lang}/pages/{page_id}.json`.
    *   **`SeoDataLoader`**: Загружает SEO-данные из `/data/json/{lang}/seo/{page_id}.json`.
    *   **`TemplateEngine`**: Инициализирует Twig.
    *   **`SeoProcessor`**: Обрабатывает плейсхолдеры в SEO-данных.
    *   **`TemplateResolver`**: Определяет путь к шаблону страницы (`/templates/pages/{page_id}.twig`).
    *   **`TemplateDataBuilder`**: Собирает все данные в единый массив для передачи в шаблон.
    *   **`Twig::render()`**: Рендерит финальный HTML и отдает его клиенту.

### 2.2. Управление данными (JSON)

Вся информация, управляющая контентом и структурой сайта, хранится в JSON-файлах. Это архитектурное ядро платформы.

*   **Глобальные данные:** `/data/json/global.json` содержит общие для всего сайта элементы (шапка, подвал, контакты, настройки языков).
*   **Данные страниц:** `/data/json/{lang}/pages/` содержит файлы, структура которых соответствует набору секций на странице. Каждый объект в JSON-файле страницы — это секция, которая рендерится своим Twig-шаблоном.
*   **SEO-данные:** `/data/json/{lang}/seo/` содержит мета-теги и другую SEO-информацию для каждой страницы.

**Правило:** Любая новая динамическая информация должна быть вынесена в JSON. В шаблонах Twig не должно быть захардкоженного контента.

### 2.3. Шаблонизация (Twig)

Система шаблонов построена на трех уровнях абстракции:

1.  **Макет (`layout.twig`):** Основной каркас HTML-страницы, включающий `<head>`, `<body>`, подключение стилей и скриптов.
2.  **Шаблоны страниц (`/templates/pages/*.twig`):** Наследуются от `layout.twig`. Их основная задача — итерировать по массиву секций, полученному из JSON, и подключать для каждой секции соответствующий шаблон.
3.  **Шаблоны секций (`/templates/sections/*.twig`):** Представляют собой крупные, независимые блоки страницы (например, «Интро», «Контакты», «О нас»).
4.  **Шаблоны компонентов (`/templates/components/*.twig`):** Мелкие, переиспользуемые элементы интерфейса (кнопки, заголовки, списки, слайдеры).

**Правило:** Новая функциональность должна реализовываться путем создания новых компонентов и секций, а не модификации существующих, если это не связано с исправлением ошибок.

## 3. Внедрение Методологии GRACE (Адаптация для PHP)

Цель — сделать кодовую базу более понятной для ИИ-агентов и новых разработчиков.

### 3.1. Контракты Модулей (`*.contract.md`)

Для каждого PHP-класса в директории `/core` (и для всех новых классов) должен быть создан сопутствующий файл с расширением `.contract.md`.

**Пример для `core/Routing/Router.php` -> `core/Routing/Router.contract.md`:**

````markdown
# Контракт Модуля: Router

*   **PURPOSE:** Определяет идентификатор страницы (`page_id`) на основе сегментов URL. Обрабатывает главную страницу и страницы ошибок.
*   **API:**
    *   `__construct(UrlParser $urlParser, LanguageService $languageService)`: Конструктор, принимает зависимости.
    *   `resolvePageId(): string`: Основной метод, возвращает `page_id`.
*   **STATE:** Класс не имеет внутреннего состояния (stateless).
*   **LINKS:**
    *   **Зависит от:** `core/Routing/UrlParser.php`, `core/Language/LanguageService.php`.
    *   **Используется в:** `core/Bootstrap/Application.php`.
````

### 3.2. Разметка Логических Блоков

Внутри методов PHP-классов для выделения логически завершенных участков кода должны использоваться структурированные комментарии.

**Пример в `Application::run()`:**

```php
// BLOCK: Language Detection
// PURPOSE: Determine the current language from the URL.
$this->languageDetector = $this->serviceContainer->get(LanguageDetector::class);
$this->language = $this->languageDetector->detect();
// END_BLOCK

// BLOCK: Routing
// PURPOSE: Resolve the page ID from the URL segments.
$this->router = $this->serviceContainer->get(Router::class);
$this->pageId = $this->router->resolvePageId();
// END_BLOCK
```

### 3.3. Структурированное Логирование

Все значимые события в приложении должны логироваться с использованием существующего класса `Logger`. Формат лога должен быть единым:

`[LEVEL][Class::Method][Step] Message`

**Пример:**

```php
$this->logger->info("[Application::run][DataLoading] Loading page data for page_id: {" . $this->pageId . "}");
```

## 4. Процедуры Разработки

### 4.1. Добавление новой страницы

Процесс добавления новой страницы строго регламентирован и описан в `dev/instructions/page-add.md`. Он включает:

1.  Создание JSON-файла данных страницы в `/data/json/{lang}/pages/`.
2.  Создание JSON-файла SEO-данных в `/data/json/{lang}/seo/`.
3.  Создание Twig-шаблона страницы в `/templates/pages/`.
4.  (Опционально) Создание JS-файла для страницы в `/assets/js/pages/`.

### 4.2. Создание новых компонентов и секций

Для автоматизации создания файлов для новых компонентов и секций используются Node.js скрипты:

*   `npm run create:section {section-name}`
*   `npm run create:component {component-name}`

Эти скрипты создают необходимые `.twig`, `.pcss` и `.js` файлы в соответствующих директориях.

## 5. Подготовка к Будущему: API-First

В соответствии с `DEVELOPMENT_PLAN.md`, платформа будет эволюционировать в сторону гибридной архитектуры. Текущая PHP-платформа должна быть готова к этому.

**Ключевая задача:** Начать рассматривать платформу не как монолит, а как **поставщика данных и HTML-фрагментов**.

**Инициативы:**

1.  **Проектирование внутреннего API:** Необходимо спроектировать и задокументировать внутренний API. Начать можно с существующих обработчиков форм (например, `form-callback`).
2.  **Создание `api.php`:** Создать новую точку входа `api.php`, которая будет обрабатывать AJAX-запросы и возвращать данные в формате JSON.
3.  **Рефакторинг обработчиков форм:** Перенести логику обработки форм из текущего контекста в новую точку входа `api.php`, чтобы отделить логику от рендеринга страниц.

Эта работа заложит фундамент для безболезненной интеграции с будущим ИИ-бэкендом на Python.

