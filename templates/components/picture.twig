{# 
  Компонент адаптивного изображения с поддержкой WebP, srcset и sizes
  
  Параметры:
  - image (обязательный) - объект изображения
  - alt - альтернативный текст
  - class - CSS классы для img
  - sizes_preset - пресет размеров: "full", "half", "quarter" (по умолчанию "full")
  - sizes - кастомная строка sizes (переопределяет preset)
  - loading - "lazy" или "eager" (по умолчанию "lazy")
  - itemprop - Schema.org атрибут
#}

{% set defaultSizes = {
  'full': '(min-width: 1441px) 1400px, (min-width: 1200px) 1200px, 100vw',
  'half': '(min-width: 1441px) 700px, (min-width: 1200px) 600px, (min-width: 992px) 50vw, 100vw',
  'half-mobile': '(max-width: 400px) 100vw, (min-width: 992px) 50vw, 100vw',
  'quarter': '(min-width: 1441px) 330px, (min-width: 1200px) 280px, (min-width: 992px) calc(25vw - 20px), 25vw',
  'gallery-thumb': '(min-width: 1441px) 330px, (min-width: 1200px) 280px, (min-width: 992px) calc(25vw - 20px), 25vw',
  'gallery-cover': '(min-width: 1200px) 600px, 100vw'
} %}

{% set preset = sizes_preset|default('full') %}
{% set imageSizes = sizes|default(defaultSizes[preset]) %}
{% set imageLoading = loading|default('lazy') %}
{% set imageClass = class|default('img-responsive') %}
{% set imageAlt = alt|default(image.alt|default('')) %}
{% set imageStyle = style|default('') %}
{% set pictureClass = picture_class|default('') %}
{% set pictureStyle = picture_style|default('') %}

{# Новый формат: horizontal/vertical #}
{% if image.horizontal is defined or image.vertical is defined %}
  <picture {% if pictureClass %}class="{{ pictureClass }}"{% endif %} {% if pictureStyle %}style="{{ pictureStyle }}"{% endif %}>
    {# Вертикальная версия для узких экранов #}
    {% if image.vertical is defined %}
      {% set vImg = image.vertical %}
      {% set vSrcset = [] %}
      {% if vImg['800'] is defined %}
        {% set vSrcset = vSrcset|merge([url(vImg['800']) ~ ' 800w']) %}
      {% endif %}
      {% if vImg['1600'] is defined %}
        {% set vSrcset = vSrcset|merge([url(vImg['1600']) ~ ' 1600w']) %}
      {% endif %}
      {% if vImg.raw is defined %}
        {% set vSrcset = vSrcset|merge([url(vImg.raw) ~ ' 1920w']) %}
      {% endif %}
      {% if vSrcset|length > 0 %}
        <source 
          media="(max-width: 767px)" 
          srcset="{{ vSrcset|join(', ') }}"
          sizes="{{ imageSizes }}"
          type="image/webp">
      {% endif %}
    {% endif %}
    
    {# Горизонтальная версия для широких экранов (по умолчанию) #}
    {% if image.horizontal is defined %}
      {% set hImg = image.horizontal %}
      {% set hSrcset = [] %}
      {% if hImg['800'] is defined %}
        {% set hSrcset = hSrcset|merge([url(hImg['800']) ~ ' 800w']) %}
      {% endif %}
      {% if hImg['1600'] is defined %}
        {% set hSrcset = hSrcset|merge([url(hImg['1600']) ~ ' 1600w']) %}
      {% endif %}
      {% if hImg.raw is defined %}
        {% set hSrcset = hSrcset|merge([url(hImg.raw) ~ ' 1920w']) %}
      {% endif %}
      {% if hSrcset|length > 0 %}
        <source 
          srcset="{{ hSrcset|join(', ') }}"
          sizes="{{ imageSizes }}"
          type="image/webp">
      {% endif %}
      {% set fallbackSrc = hImg['800']|default(hImg['1600']|default(hImg.raw)) %}
    {% elseif image.vertical is defined %}
      {% set vImg = image.vertical %}
      {% set fallbackSrc = vImg['800']|default(vImg['1600']|default(vImg.raw)) %}
    {% endif %}
    
    <img 
      src="{{ url(fallbackSrc) }}" 
      alt="{{ imageAlt }}" 
      loading="{{ imageLoading }}" 
      decoding="async"
      class="{{ imageClass }}"
      {% if imageStyle %}style="{{ imageStyle }}"{% endif %}
      {% if itemprop is defined %}itemprop="{{ itemprop }}"{% endif %}>
  </picture>

{# Новый формат: прямые ключи raw/1600/800 #}
{% elseif image.raw is defined or image['1600'] is defined or image['800'] is defined %}
  {% set srcsetItems = [] %}
  {% if image['800'] and image['800'] != '#' %}
    {% set srcsetItems = srcsetItems|merge([url(image['800']) ~ ' 800w']) %}
  {% endif %}
  {% if image['1600'] and image['1600'] != '#' %}
    {% set srcsetItems = srcsetItems|merge([url(image['1600']) ~ ' 1600w']) %}
  {% endif %}
  {% if image.raw and image.raw != '#' %}
    {% set srcsetItems = srcsetItems|merge([url(image.raw) ~ ' 1920w']) %}
  {% endif %}
  {% set fallbackSrc = image['800']|default(image['1600']|default(image.raw)) %}
  
  <picture {% if pictureClass %}class="{{ pictureClass }}"{% endif %} {% if pictureStyle %}style="{{ pictureStyle }}"{% endif %}>
    {% if srcsetItems|length > 0 %}
      <source 
        srcset="{{ srcsetItems|join(', ') }}" 
        sizes="{{ imageSizes }}" 
        type="image/webp">
    {% endif %}
    <img 
      src="{{ url(fallbackSrc) }}" 
      alt="{{ imageAlt }}" 
      loading="{{ imageLoading }}" 
      decoding="async"
      class="{{ imageClass }}"
      {% if imageStyle %}style="{{ imageStyle }}"{% endif %}
      {% if itemprop is defined %}itemprop="{{ itemprop }}"{% endif %}>
  </picture>

{# Старый формат: sources (обратная совместимость) #}
{% elseif image.sources is defined %}
  <picture {% if pictureClass %}class="{{ pictureClass }}"{% endif %} {% if pictureStyle %}style="{{ pictureStyle }}"{% endif %}>
    {% if image.sources.mobile is defined %}
      {% set mobileSrc = image.sources.mobile.src is defined ? image.sources.mobile.src : image.sources.mobile %}
      <source 
        media="(max-width: 767px)" 
        srcset="{{ url(mobileSrc) }}"
        type="image/webp">
    {% endif %}
    {% set desktopImg = image.sources.desktop is defined ? image.sources.desktop : (image.sources.default is defined ? image.sources.default : null) %}
    {% if desktopImg %}
      {% set desktopSrc = desktopImg.src is defined ? desktopImg.src : desktopImg %}
      <img 
        src="{{ url(desktopSrc) }}" 
        alt="{{ imageAlt }}" 
        loading="{{ imageLoading }}" 
        decoding="async"
        class="{{ imageClass }}"
        {% if imageStyle %}style="{{ imageStyle }}"{% endif %}
        {% if itemprop is defined %}itemprop="{{ itemprop }}"{% endif %}>
    {% endif %}
  </picture>

{# Старый формат: versions (обратная совместимость) #}
{% elseif image.versions is defined and image.versions %}
  {% set srcsetItems = [] %}
  {% if image.versions['800'] is defined %}
    {% set srcsetItems = srcsetItems|merge([url(image.versions['800']) ~ ' 800w']) %}
  {% endif %}
  {% if image.versions['1600'] is defined %}
    {% set srcsetItems = srcsetItems|merge([url(image.versions['1600']) ~ ' 1600w']) %}
  {% endif %}
  {% if image.versions.raw is defined %}
    {% set srcsetItems = srcsetItems|merge([url(image.versions.raw) ~ ' 1920w']) %}
  {% endif %}
  {% set fallbackSrc = image.versions['1600']|default(image.versions['800']|default(image.versions.raw)) %}
  
  <picture {% if pictureClass %}class="{{ pictureClass }}"{% endif %} {% if pictureStyle %}style="{{ pictureStyle }}"{% endif %}>
    {% if srcsetItems|length > 0 %}
      <source 
        srcset="{{ srcsetItems|join(', ') }}" 
        sizes="{{ imageSizes }}" 
        type="image/webp">
    {% endif %}
    <img 
      src="{{ url(fallbackSrc) }}" 
      alt="{{ imageAlt }}" 
      loading="{{ imageLoading }}" 
      decoding="async"
      class="{{ imageClass }}"
      {% if imageStyle %}style="{{ imageStyle }}"{% endif %}
      {% if itemprop is defined %}itemprop="{{ itemprop }}"{% endif %}>
  </picture>

{# Старый формат: src (обратная совместимость) #}
{% elseif image.src is defined %}
  <picture {% if pictureClass %}class="{{ pictureClass }}"{% endif %} {% if pictureStyle %}style="{{ pictureStyle }}"{% endif %}>
    <img 
      src="{{ url(image.src) }}" 
      alt="{{ imageAlt }}" 
      loading="{{ imageLoading }}" 
      decoding="async"
      class="{{ imageClass }}"
      {% if imageStyle %}style="{{ imageStyle }}"{% endif %}
      {% if itemprop is defined %}itemprop="{{ itemprop }}"{% endif %}>
  </picture>

{# Fallback: заглушка #}
{% else %}
  <img 
    src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='100' height='100'%3E%3Crect fill='%23ddd' width='100' height='100'/%3E%3C/svg%3E" 
    alt="{{ imageAlt|default('Image not available') }}" 
    class="{{ imageClass }}">
{% endif %}
