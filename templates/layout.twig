{# layout.twig #}
<!doctype html>
<html lang="{{ lang_code }}" class="{{ currentLang.direction|default('ltr') }}" dir="{{ currentLang.direction|default('ltr') }}">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta http-equiv="X-UA-Compatible" content="ie=edge">
  <title>{{ pageTitle|default('Заголовок страницы по умолчанию')|raw }}</title>
  
  {% if pageSeoData and pageSeoData.meta %}
    {% for meta in pageSeoData.meta %}
      {% if meta.name %}
        <meta name="{{ meta.name }}" content="{{ meta.content|raw }}">
      {% elseif meta.property %}
        <meta property="{{ meta.property }}" content="{{ meta.content|raw }}">
      {% endif %}
    {% endfor %}
  {% endif %}
  
  {# Логика формирования current_url, canonical и alternate, как было предоставлено (с минимальными правками для сборки URL) #}
  {% set _base_url_trimmed = base_url|trim('/') %} {# base_url без слешей по краям #}

  {% if page_id == 'portfolio-detail' and project is defined and project.slug is defined %}
    {% set _path_segment = 'portfolio/' ~ project.slug %}
  {% elseif page_id == 'blog-detail' and article is defined and article.slug is defined %}
    {% set _path_segment = 'blog/' ~ article.slug %}
  {% elseif page_id in ['portfolio-chastnye-sady', 'portfolio-obshchestvennye-prostranstva'] %}
    {% set _path_segment = page_id %}
  {% elseif page_id in ['chastnye-sady', 'obshchestvennye-prostranstva'] %}
    {% set _path_segment = page_id %}
  {% elseif page_id == 'index' %}
    {% set _path_segment = '' %}
  {% else %}
    {% set _path_segment = page_id %}
  {% endif %}

  {% if route_params|length > 0 and _path_segment != '' %}
    {% set _path_segment = _path_segment ~ '/' ~ route_params|join('/') %}
  {% elseif route_params|length > 0 and _path_segment == '' %}
     {% set _path_segment = route_params|join('/') %}
  {% endif %}

  {# Добавляем префикс scope (op), если он активен #}
  {% if current_scope == 'op' %}
    {% if _path_segment == '' %}
      {% set _path_segment = 'op' %}
    {% else %}
      {% set _path_segment = 'op/' ~ _path_segment %}
    {% endif %}
  {% endif %}

  {% set _final_path_for_current_url = (_path_segment != '') ? '/' ~ _path_segment ~ '/' : '/' %}
  {% set current_url = _base_url_trimmed ~ _final_path_for_current_url %}


  {% set _base_domain_for_seo = base_url|replace({'http://': '', 'https://': ''})|split('/')[0] %}
  {% set _base_secure_domain_for_seo = 'https://' ~ _base_domain_for_seo %}
  
  {% set _url_path_for_seo = _path_segment %}

  {% if is_lang_in_url and lang_code != config.settings.default_lang %}
    {% set _url_prefix_for_seo = _base_secure_domain_for_seo ~ '/' ~ lang_code %}
  {% else %}
    {% set _url_prefix_for_seo = _base_secure_domain_for_seo %}
  {% endif %}
  
  {% set _canonical_parts = [_url_prefix_for_seo|trim('/'), _url_path_for_seo|trim('/')] %}
  {% set final_canonical_url = _canonical_parts|filter(v => v is not empty and v is not null)|join('/') %}
  {% if not final_canonical_url ends with '/' %}{% set final_canonical_url = final_canonical_url ~ '/' %}{% endif %}
  {% if not final_canonical_url starts with 'https://' %}{% set final_canonical_url = _base_secure_domain_for_seo ~ '/' ~ final_canonical_url %}{% endif %}


  <link rel="canonical" href="{{ final_canonical_url }}" />
  
  {% for lang_loop_code in config.settings.available_langs %}
    {# Пропускаем текущий язык - не добавляем rel="alternate" для него #}
    {% if lang_loop_code != lang_code %}
      {% if lang_loop_code == config.settings.default_lang %}
        {% set _alt_url_base_for_seo = _base_secure_domain_for_seo %}
      {% else %}
        {% set _alt_url_base_for_seo = _base_secure_domain_for_seo ~ '/' ~ lang_loop_code %}
      {% endif %}

      {% set _alt_url_parts = [_alt_url_base_for_seo|trim('/'), _url_path_for_seo|trim('/')] %}
      {% set final_alt_url = _alt_url_parts|filter(v => v is not empty and v is not null)|join('/') %}
      {% if not final_alt_url ends with '/' and _url_path_for_seo != '' %}{% set final_alt_url = final_alt_url ~ '/' %}{% endif %}
      {% if _url_path_for_seo == '' and not final_alt_url ends with '/' %}{% set final_alt_url = final_alt_url ~ '/' %}{% endif %}
      {% if not final_alt_url starts with 'https://' %}{% set final_alt_url = _base_secure_domain_for_seo ~ '/' ~ final_alt_url|trim('/') %}{% endif %}

      <link rel="alternate" href="{{ final_alt_url }}" hreflang="{{ lang_loop_code }}" />
    {% endif %}
  {% endfor %}
  
  {% if page_id == 'index' %}
    <link rel="alternate" href="{{ _base_secure_domain_for_seo ~ '/' }}" hreflang="x-default" />
  {% endif %}

  <script>
    window.appConfig = {
      baseUrl: "{{ base_url | e('js') }}", 
      langCode: "{{ lang_code | e('js') }}",
      YANDEX_METRIC_ID: 75033004
    };
  </script>
  
  {% include 'components/analytics.twig' %}
  
  {% include 'components/styles.twig' %}
  
  {% include 'components/favicons.twig' %}
  
  {% include 'components/scripts.twig' %}
  
  {# Микроразметка Schema.org Organization #}
  <script type="application/ld+json">
  {
    "@context": "https://schema.org",
    "@type": "Organization",
    "name": "{{ site.name|default('Company') }}",
    {% if global.logo.black is defined %}
    "logo": "{{ _base_secure_domain_for_seo ~ '/' ~ global.logo.black.src }}",
    {% endif %}
    "url": "{{ _base_secure_domain_for_seo }}",
    {% if global.email is defined %}
    "email": "{{ global.email.title|replace({'<span>': '', '</span>': ''})|raw }}",
    {% endif %}
    {% if global.phones is defined and global.phones|length > 0 %}
    "telephone": [
      {% for phone in global.phones %}
      "{{ phone.title|replace({'<span>': '', '</span>': ''})|raw }}"{% if not loop.last %},{% endif %}
      {% endfor %}
    ],
    {% endif %}
    {% if global.address[lang_code] is defined and global.address[lang_code]|length > 0 %}
    "address": [
      {% for address in global.address[lang_code] %}
      {
        "@type": "PostalAddress",
        "streetAddress": "{{ address.title|replace({'<span>': '', '</span>': ''})|raw }}"
      }{% if not loop.last %},{% endif %}
      {% endfor %}
    ],
    {% endif %}
    {% if global.socials is defined and global.socials|length > 0 %}
    "sameAs": [
      {% for social in global.socials %}
      {% if social.visible %}
      "{{ social.href }}"{% if not loop.last %},{% endif %}
      {% endif %}
      {% endfor %}
    ]
    {% endif %}
  }
  </script>

  {% if pageSeoData.json_ld is defined and pageSeoData.json_ld is not empty %}
  <script type="application/ld+json">
    {{ pageSeoData.json_ld | raw }}
  </script>
  {% endif %}
</head>

<body class="page-{{ pageData.name|default(page_id) }}">
  {% block content %}{% endblock %}
  {# Глобальное подключение cookie-panel #}
  {% include 'sections/cookie-panel.twig' %}
</body>

</html>